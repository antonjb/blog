---
import type { CollectionEntry } from 'astro:content'
import { remark } from 'remark'
import strip from 'strip-markdown'
import { Image } from 'astro:assets'
import Stack from './stack.astro'


interface Props {
    post: CollectionEntry<'posts'>
}

async function getExcerpt(markdown: string, length = 400) {
    const result = await remark().use(strip).process(markdown)
    const text = String(result).split(/\n\n/)[0].trim()
    if (text.length <= length) return text
    return text.slice(0, length).replace(/\s+\S*$/, '') + 'â€¦'
}

const {post} = Astro.props

const excerpt = await getExcerpt(post.body ?? '', 400)

---

<Stack element="article" space="1">
    {post.data.heroImage && (
        <a href={`/blog/${post.id}`} tabindex="-1">
            <Image
                src={post.data.heroImage}
                alt=""
                width={800}
                height={200}
                class="post-image"
            />
        </a>
    )}
    <Stack element="header" space="0">
        <h2 class="post-title">
            <a href={`/blog/${post.id}`}>{post.data.title}</a>
        </h2>
        <time
            class="post-date"
            datetime={post.data.date.toISOString()}
        >
            {post.data.formattedDate}
        </time>
    </Stack>
    <p>
        {excerpt}
    </p>
    <a href={`/blog/${post.id}`} class="post-link">
        Continue reading
        <span class="visually-hidden">: {post.data.title}</span>
    </a>
</Stack>

<style>
    .post-image {
        aspect-ratio: 4 / 1;
        object-fit: cover;
        object-position: center;
    }

    .post-title {
        font-size: 1.5rem;
        margin: 0;
    }

    .post-title a {
        text-decoration: none;
        transition: color 0.1s linear;
    }

    .post-title a:hover,
    .post-title a:focus-visible {
        text-decoration: underline;
        color: var(--color-primary);
    }

    .post-date {
        color: rgb(0 0 0 / 0.6);
        font-size: 0.875rem;
    }

    .post-link {
        color: var(--color-primary);
        text-decoration: none;
    }

    .post-link:hover,
    .post-link:focus-visible {
        text-decoration: underline;
    }
</style>
