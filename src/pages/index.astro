---
import { getCollection } from 'astro:content'
import { Image } from 'astro:assets'
import { remark } from 'remark'
import strip from 'strip-markdown'
import Layout from '../layouts/Layout.astro'
import Stack from '../components/stack.astro'

async function getExcerpt(markdown: string, length = 400) {
    const result = await remark().use(strip).process(markdown)
    const text = String(result).split(/\n\n/)[0].trim()
    if (text.length <= length) return text
    return text.slice(0, length).replace(/\s+\S*$/, '') + 'â€¦'
}

const posts = await getCollection('posts')
posts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime())

const postsWithExcerpts = await Promise.all(
    posts.map(async (post) => ({
        ...post,
        excerpt: await getExcerpt(post.body ?? '', 400),
    }))
)
---

<Layout>
    <Stack element="main" space="3">
        {
            postsWithExcerpts.map((post) => (
                <article class="post-card">
                    {post.data.heroImage && (
                        <a href={`/blog/${post.id}`} tabindex="-1">
                            <Image
                                src={post.data.heroImage}
                                alt=""
                                width={800}
                                height={200}
                                class="post-image"
                            />
                        </a>
                    )}
                    <header>
                        <h2 class="post-title">
                            <a href={`/blog/${post.id}`}>{post.data.title}</a>
                        </h2>
                        <time
                            class="post-date"
                            datetime={post.data.date.toISOString()}
                        >
                            {post.data.formattedDate}
                        </time>
                    </header>
                    <p class="post-description">
                        {post.excerpt}
                    </p>
                    <a href={`/blog/${post.id}`} class="post-link">
                        Continue reading
                        <span class="visually-hidden">: {post.data.title}</span>
                    </a>
                </article>
            ))
        }
    </Stack>
</Layout>

<style>
    .post-card {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
    }

    .post-image {
        aspect-ratio: 4 / 1;
        object-fit: cover;
        object-position: center;
    }

    .post-title {
        font-size: 1.5rem;
        margin: 0;
    }

    .post-title a {
        text-decoration: none;
        transition: color 0.1s linear;
    }

    .post-title a:hover,
    .post-title a:focus-visible {
        text-decoration: underline;
        color: var(--color-primary);
    }

    .post-date {
        color: rgb(0 0 0 / 0.6);
        font-size: 0.875rem;
    }

    .post-description {
        margin: 0;
    }

    .post-link {
        color: var(--color-primary);
        text-decoration: none;
    }

    .post-link:hover,
    .post-link:focus-visible {
        text-decoration: underline;
    }
</style>
